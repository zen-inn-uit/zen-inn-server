enum Role {
  CUSTOMER
  PARTNER
  ADMIN
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum UserStatus {
  ACTIVE
  PENDING
  BANNED
}

enum Provider {
  PASSWORD
  GOOGLE
  FACEBOOK
}

enum OtpPurpose {
  VERIFY_EMAIL
  LOGIN
  RESET
}

enum HotelStatus {
  DRAFT
  ACTIVE
  INACTIVE
}

enum DealType {
  LATE_ESCAPE
  EARLY_BIRD
  FLASH_SALE
  SEASONAL
}

enum AmenityCategory {
  ROOM_FEATURE
  BATHROOM
  ENTERTAINMENT
  CONVENIENCE
  SAFETY
  ACCESSIBILITY
}

enum BedType {
  SINGLE
  DOUBLE
  QUEEN
  KING
  TWIN
  BUNK
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  SEPAY
  BANK_TRANSFER
  CASH
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String?
  role         Role    @default(CUSTOMER)

  status          UserStatus @default(PENDING)
  provider        Provider   @default(PASSWORD)
  providerId      String?
  emailVerifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings Booking[]
  partner  Partner?
  sessions AuthSession[]
  otps     OtpCode[]
}

model Partner {
  id        String    @id @default(cuid())
  userId    String    @unique
  user      User      @relation(fields: [userId], references: [id])
  company   String?
  hotels    Hotel[]
  kycStatus KycStatus @default(PENDING)

  kycDocuments         KycDocument[]
  cancellationPolicies CancellationPolicy[]
  ratePlans            RatePlan[]
}

model Hotel {
  id        String   @id @default(cuid())
  partnerId String
  partner   Partner  @relation(fields: [partnerId], references: [id])

  name        String
  address     String            // địa chỉ cụ thể (số nhà, đường)
  city        String
  country     String
  starRating  Int?              // 1..5, nullable nếu chưa set
  phone       String?
  description String?
  images      HotelImage[]

  status    HotelStatus @default(DRAFT)

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?

  rooms     Room[]
}

model HotelImage {
  id        String   @id @default(cuid())
  hotelId   String
  hotel     Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  url       String
  displayOrder Int @default(0)
  createdAt DateTime @default(now())
}

model Room {
  id              String    @id @default(cuid())
  hotelId         String
  hotel           Hotel     @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  
  name            String    // "Deluxe Double Room"
  roomType        String    // loại phòng
  description     String?
  
  capacity        Int       @default(2)    // số người
  area            Float?    // diện tích (feet² hoặc m²)
  
  availableCount  Int       @default(0)    // số phòng còn lại
  totalCount      Int       @default(1)    // tổng số phòng loại này
  
  images          RoomImage[]
  beds            Bed[]
  amenities       RoomAmenity[]
  ratePlans       RatePlan[]
  deals           Deal[]
  
  bookings        Booking[]
  
  cancellationPolicyId String?
  cancellationPolicy   CancellationPolicy? @relation("RoomToPolicy", fields: [cancellationPolicyId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Bed {
  id        String    @id @default(cuid())
  roomId    String
  room      Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  bedType   BedType   // QUEEN, KING, TWIN, DOUBLE, SINGLE, BUNK
  quantity  Int       @default(1) // số lượng giường loại này
  
  createdAt DateTime  @default(now())
}

model RoomImage {
  id        String   @id @default(cuid())
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  url       String
  displayOrder Int @default(0)
  createdAt DateTime @default(now())
}

model Amenity {
  id          String  @id @default(cuid())
  name        String  // "Air conditioning", "Private bathroom"
  description String?
  icon        String?
  category    AmenityCategory
  createdAt   DateTime @default(now())
  
  roomAmenities RoomAmenity[]
  
  @@unique([name])
}

model RoomAmenity {
  id        String   @id @default(cuid())
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  amenityId String
  amenity   Amenity  @relation(fields: [amenityId], references: [id])
  createdAt DateTime @default(now())
  
  @@unique([roomId, amenityId])
}

model RatePlan {
  id                      String    @id @default(cuid())
  partnerId               String
  partner                 Partner   @relation(fields: [partnerId], references: [id])
  
  rooms                   Room[]
  
  // Thông tin cơ bản
  name                    String    // "BAR", "Non-refundable Rate", "Breakfast Included"
  description             String?
  rateCode                String?   // mã rate plan (e.g., "BAR", "NR", "BIC")
  
  // Giá
  basePrice               Int       // giá cơ bản (tính theo cent)
  minLos                  Int @default(1) // minimum length of stay (đêm)
  maxLos                  Int?       // maximum length of stay
  
  // Thời gian áp dụng
  validFrom               DateTime
  validUntil              DateTime
  
  // Chính sách hủy - reference to CancellationPolicy
  cancellationPolicyId    String?
  cancellationPolicy      CancellationPolicy? @relation(fields: [cancellationPolicyId], references: [id])
  
  // Legacy fields (deprecated, use cancellationPolicy instead)
  refundablePercent       Int @default(100) // % hoàn tiền (0-100)
  depositRequired         Boolean @default(false) // yêu cầu đặt cọc
  depositPercent          Int @default(0) // % đặt cọc (0-100)
  
  // Điều kiện lưu trú
  includesBreakfast       Boolean @default(false)
  includesDinner          Boolean @default(false)
  includesParking         Boolean @default(false)
  otherInclusions         String?   // các dịch vụ khác bao gồm
  
  // Điều kiện khách
  minGuestCount           Int @default(1)
  maxGuestCount           Int?
  
  // Quy định thay đổi
  modificationAllowed      Boolean @default(true)
  modificationFee         Int @default(0) // phí thay đổi (tính theo cent)
  
  // Loại rate plan (để phân loại)
  rateType                String? // "BAR", "CORPORATE", "LONG_STAY", etc
  
  active                  Boolean @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  bookings                Booking[]
}

model Deal {
  id          String    @id @default(cuid())
  roomId      String
  room        Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  name        String    // "Late Escape Deal", "Flash Sale"
  description String?
  dealType    DealType
  badge       String?   // text hiển thị trên badge
  validFrom   DateTime
  validUntil  DateTime
  createdAt   DateTime  @default(now())
}

model Booking {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id])
  roomId    String
  room      Room          @relation(fields: [roomId], references: [id])
  ratePlanId String?
  ratePlan  RatePlan?     @relation(fields: [ratePlanId], references: [id])
  
  // Date range
  checkIn   DateTime
  checkOut  DateTime
  nightCount Int
  
  // Guest information
  guestName  String
  guestEmail String
  guestPhone String
  guestCount Int
  
  // Pricing
  totalPrice Int  // in cents
  
  // Payment
  paymentMethod    PaymentMethod
  paymentStatus    PaymentStatus @default(PENDING)
  paymentIntentId  String?
  transactionId    String?
  
  // Additional info
  specialRequests  String?
  
  // Status
  status    BookingStatus @default(PENDING)
  
  // Cancellation
  cancelledAt       DateTime?
  cancellationReason String?
  
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model AuthSession {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshHash String
  userAgent   String?
  ip          String?
  createdAt   DateTime  @default(now())
  revokedAt   DateTime?
}

model OtpCode {
  id         String     @id @default(cuid())
  userId     String
  user       User       @relation(fields: [userId], references: [id])
  purpose    OtpPurpose
  codeHash   String
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime   @default(now())

  @@index([userId, purpose])
}

model KycDocument {
  id        String  @id @default(cuid())
  partnerId String
  partner   Partner @relation(fields: [partnerId], references: [id])

  kind String
  url  String

  createdAt DateTime @default(now())

  @@index([partnerId, kind])
}

model CancellationPolicy {
  id                    String    @id @default(cuid())
  partnerId             String
  partner               Partner   @relation(fields: [partnerId], references: [id])
  
  name                  String    // "Flexible", "Moderate", "Strict"
  description           String?
  
  // Cancellation windows
  freeCancellationHours Int       // Hours before check-in for free cancellation
  refundablePercent     Int       // % refund if cancelled after free window (0-100)
  noShowRefundPercent   Int @default(0) // % refund for no-show
  
  // Modification policy
  modificationAllowed   Boolean @default(true)
  modificationFeePercent Int @default(0) // % of booking total
  
  active                Boolean @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  ratePlans             RatePlan[]
  rooms                 Room[]    @relation("RoomToPolicy")
  
  @@index([partnerId])
}

model SystemLog {
  id                String    @id @default(cuid())
  
  // Event information
  eventType         String    // "booking_created", "payment_completed", etc.
  eventCategory     String    // "booking", "payment", "auth", "kyc"
  severity          String    // "info", "warning", "error"
  
  // Context
  userId            String?
  resourceId        String?   // booking ID, hotel ID, etc.
  resourceType      String?   // "booking", "hotel", "user"
  
  // Details
  message           String
  metadata          Json?     // Additional structured data
  
  // Request context
  ipAddress         String?
  userAgent         String?
  
  createdAt         DateTime @default(now())
  
  @@index([eventType, createdAt])
  @@index([userId, createdAt])
  @@index([eventCategory, createdAt])
}
